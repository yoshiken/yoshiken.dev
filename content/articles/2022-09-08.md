Title: 90æ—¥å¾Œã«æ­»ã‚“ã EKS
Date: 2022-09-08 14:59:36
Category: tech
Summary: EKS1.21ä»¥ä¸Šã«ã™ã‚‹ã¨90æ—¥å¾Œã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒæ¥ã¦æ­»ã¬

## EKS1.21ä»¥ä¸Šã«ã™ã‚‹ã¨90æ—¥å¾Œã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒæ¥ã¦æ­»ã¬


### TL;DR

- Kubernetesã®BoundServiceAccountTokenVolumeã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒå°å…¥ã•ã‚ŒãŸ
- EKS1.21ã‹ã‚‰ä¸Šè¨˜æ©Ÿèƒ½ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹
- kube2iamã‚„K8s-External-Secretãªã©ã§å¤ã„ã‚„ã¤ä½¿ã£ã¦ã‚‹ã¨90æ—¥å¾Œã«æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­»ã¬


### ä½•ãŒèµ·ããŸã‹

å”çªã«9/6ä»¥é™ã®cron jobé”ãŒã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã§ããšã«æ­»ã‚“ã§ã„ã£ãŸã€‚

ä¸å¹¸ä¸­ã®å¹¸ã„ã§ãƒ¡ã‚¤ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ã®serverã¯è«¸ã€…ã®äº‹æƒ…ãŒã‚ã£ã¦ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã¯kube2iamã§å–å¾—ã—ã¦ã„ãªã‹ã£ãŸã®ã§ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã¯æ­»ãªãªã‹ã£ã£ãŸã€‚

### èª¿æŸ»

ã¨ã‚Šã‚ãˆãšå›°ã£ãŸã‚‰logã‚’è¦‹ã‚‹ã€‚å¤§äº‹ã€‚

ä»¥ä¸‹ã®logãŒç™ºè¦‹ã§ãã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«å‘¨ã‚Šã‚’ç–‘ã†

```
failed fetch events: NoCredentialProviders: no valid providers in chain. Deprecated.\\\\n\\\\tFor verbose messaging see aws.Config.CredentialsChainVerboseErrors
```

æœ€åˆã¯k8sã®è¨¼æ˜æ›¸å‘¨ã‚ŠãŒå–å¾—ã§ããªã„ã®ã‹ã¨æ€ã£ã¦ã„ãŸãŒ(å‰ç§‘ã‚ã‚Š)ã€å•é¡Œãªã•ãã†ã€‚

AWSå›ºæœ‰ã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã€ã¤ã¾ã‚Šã¯IAMå‘¨ã‚ŠãŒæ€ªã—ã„ã®ã§ã¯ï¼Ÿã¨kub2iamã®logã‚’è¦‹ãŸã‚‰ä»¥ä¸‹ã®log

```
"E0905 16:42:08.534890       1 reflector.go:300] github.com/jtblin/kube2iam/vendor/k8s.io/client-go/tools/cache/reflector.go:94: Failed to watch *v1.Namespace: the server has asked for the client to provide credentials (get namespaces)\n"
```

ã¤ã¾ã‚Šã¯ **å„podã«IAMã‚’å‰²ã‚ŠæŒ¯ã‚Šã™ã‚‹kube2iamè‡ªä½“ãŒã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã§ããªã„** ã¨ã„ã†ã“ã¨ã€‚

kube2iamã£ã¦ä½•ã‚„ã­ã‚“ã£ã¦è©±ã¯ã“ã“ã§ã¯ã—ãªã„ã®ã§githubã§ã‚‚è¦‹ã¦ãã‚Œã€‚

[https://github.com/jtblin/kube2iam](https://github.com/jtblin/kube2iam)

### ç‰¹å®š

ã‚¨ãƒ©ãƒ¼æ–‡ã§æ¤œç´¢ã—ã¦ã‚‚ã„ã¾ã„ã¡ãƒ”ãƒ³ã¨ãã‚‹è§£æ±ºæ³•ãŒè¦‹å½“ãŸã‚‰ãªã„ã€‚æœ€è¿‘kube2iamå‘¨ã‚Šã‚‚è§¦ã£ãŸè¨˜æ†¶ã‚‚è¨˜éŒ²ã‚‚ãªã„ã€‚

ã§ã€ã€Œã‚‚ã—ã‹ã—ãŸã‚‰AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã«ãƒ’ãƒ³ãƒˆã¨ã‹ãªã„ã‹ãªã€œã€‚æµçŸ³ã«ã”éƒ½åˆä¸»ç¾©ã‹ãªã€œã€‚ã€ã¨è¦‹ã«è¡Œã£ãŸã‚‰ã‚ã£ãŸã€‚


>Kubernetes BoundServiceAccountTokenVolume æ©Ÿèƒ½ ã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚ã“ã®æ©Ÿèƒ½ã¯ EKS v1.21 ä»¥é™ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚API ã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚



ã‚ãƒ¼ãŸã—ã‹ã«ãƒˆãƒ¼ã‚¯ãƒ³åˆ‡ã‚ŒãŸã‚‰å‡ºãã†ãªã‚¨ãƒ©ãƒ¼ã ãªã€œã€‚ã§ã‚‚æœ€è¿‘å¼å¹´é·å®®ã—ãŸã—å¯èƒ½æ€§ãŒä½ã„ã‹ãªã€œã€‚ã¨ã‹æ€ã„ã¤ã¤å°‘ã—æ·±å €ã‚Šã—ãŸã€‚

("å¼å¹´é·å®®"ã¨ã¯ä¿—ã«è¨€ã†ClusterMigrationã¨å‘¼ã°ã‚Œã‚‹ã‚„ã¤ã§è©³ã—ãã¯[éå»ã«ç™»å£‡ã—ãŸã‚¹ãƒ©ã‚¤ãƒ‰](https://speakerdeck.com/yoshiken/zhuan-sheng-sitaraekswoterraformguan-li-surukotoninatutajian?slide=17)è¦‹ã¦ãã‚Œ


[https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html#kubernetes-1.21](https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html#kubernetes-1.21)


>BoundServiceAccountTokenVolume graduated to beta and is enabled by default in Kubernetes version 1.21. This feature improves security of service account tokens by allowing workloads running on Kubernetes to request JSON web tokens that are audience, time, and key bound. Service account tokens now have an expiration of one hour. In previous Kubernetes versions, they didn't have an expiration. This means that clients that rely on these tokens must refresh the tokens within an hour.
>(ä¸­ç•¥)
>If your workload is using an older client version, then you must update it. To enable a smooth migration of clients to the newer time-bound service account tokens, Kubernetes version 1.21 adds an extended expiry period to the service account token over the default one hour. For Amazon EKS clusters, the extended expiry period is 90 days. Your Amazon EKS cluster's Kubernetes API server rejects requests with tokens older than 90 days. We recommend that you check your applications and their dependencies to make sure that the Kubernetes client SDKs are the same or later than the versions listed previously.


ãˆ"

>  For Amazon EKS clusters, the extended expiry period is 90 days. Your Amazon EKS cluster's Kubernetes API server rejects requests with tokens older than 90 days.

ğŸ¤”

ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”

```bash
$aws eks describe-cluster --name xxxxxxxxxxxx --query "cluster.createdAt" --output text
2022-06-06T22:29:01.251000+09:00
$kubectl get pod -n kube-system
NAME                                            READY   STATUS    RESTARTS   AGE
aws-load-balancer-controller-xxxxxxxxxxxxxxxx   1/1     Running   0          23h
aws-load-balancer-controller-xxxxxxxxxxxxxxxx   1/1     Running   0          23h
aws-node-xxxxx                                  1/1     Running   0          93d
aws-node-xxxxx                                  1/1     Running   0          93d
coredns-xxxxxxxxxx-xxxxx                        1/1     Running   0          93d
coredns-xxxxxxxxxx-xxxxx                        1/1     Running   0          93d
kube-proxy-xxxxx                                1/1     Running   0          93d
kube-proxy-xxxxx                                1/1     Running   0          93d
kube2iam-xxxxx                                  1/1     Running   0          93d
kube2iam-xxxxx                                  1/1     Running   0          93d
kubernetes-external-secrets-xxxxxxxxxxxxxxx     1/1     Running   2          92d
```

ä»Šæ—¥ã¯9/8

éšœå®³ã¯9/6

EKSåŠã³kube2iamä½œæˆã¯6/6

ã‚‚ã‚ã«90æ—¥å¾Œã‚„ã‚“ã‘!!!!!!!!!!!!!!!!!


### å¯¾å¿œ

ä»–ã«ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®tokenåˆ‡ã‚ŒãŒã„ãªã„ã‹ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’CloudWatch Logs Insightsã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã®ãƒ­ã‚°ã§èµ°ã‚‰ã›ã‚‹ã€‚å¼Šç¤¾ã®å ´åˆã—ã‚Œã£ã¨kubernetes-external-secretsã‚‚æ­»ã‚“ã§ã„ãŸã€‚(kube2iamã‚‚ãã†ãªã‚“ã ãŒå®Œå…¨ã«æ­»ã‚“ã§ã„ã‚‹ã‚ã‘ã§ã¯ãªããŸã¾ã«ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒå–ã‚Œã¦ã„ã‚‹ã¨ããŒã‚ã‚‹ã®ã¯çµå±€è¬ã ã£ãŸ

```
fields @timestamp
| filter @logStream like /kube-apiserver-audit/
| filter @message like /seconds after warning threshold/
| parse @message "subject: *, seconds after warning threshold:*\"" as subject, elapsedtime
```

ã‚‚ã¨ã‚ˆã‚Šè«¸ã€…ã®APIã‚„ã‚‰moduleãŒå¤ã„ã®ã§æœ€æ–°ã«ã™ã‚‹äºˆå®šã ã£ãŸãŒä»Šå›ã®éšœå®³ã§å„ªå…ˆé †ä½ãŒä¸ŠãŒã£ãŸã€‚

ã¨ã‚Šã‚ãˆãšã®å¯¾å¿œã¨ã—ã¦æ–°ãŸã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã•ãˆç™ºè¡Œã§ãã‚Œã°ãˆãˆã‚“ã‚„ã‚ç²¾ç¥ã§å†èµ·å‹•ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ç›´ã—ã¦ã€90æ—¥å¾Œã®googleCalendarã«äºˆå®šã‚’å…¥ã‚ŒãŸã€‚

```bash
$kubectl rollout restart daemonset kube2iam -n kube-system
$kubectl rollout restart deploy kubernetes-external-secrets -n kube-system
```

### ã¾ã¨ã‚

æœ¬è³ªçš„ãªã¨ã“ã‚ã¯[å‰ã®è¨˜äº‹ã§ã‚‚æ›¸ã„ãŸ](https://yoshiken.dev/articles/2022-07-24)ãŒã€EKSã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å¼•ãç¶™ããŒä¸­é€”åŠç«¯ã ã£ãŸã¨ã„ã†ã¨ã“ã‚ã«èµ·å› ã—ã¦ã—ã¾ã†ã€‚

ãã‚Œã§ã‚‚å¼·ã„ã¦è¨€ã†ãªã‚‰

ãƒ‘ãƒƒãƒãƒãƒ¼ãƒˆã«èµ¤æ–‡å­—ã§ `Important` ã£ã¦æ›¸ã„ã¦ã‚ã‚‹ã‚„ã¤ã¯ã¡ã‚ƒã‚“ã¨è¦‹ã¾ã—ã‚‡ã†ã€‚

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã¯ãƒãƒ©ãƒãƒ©è¦‹ã«ã„ãã¾ã—ã‚‡ã†ã€‚

ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¯ã“ã¾ã‚ã«ã—ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸Š3ç‚¹ã€‚å¾—ã‚‹ã‚‚ã®ã¯å°‘ãªã£ãŸã€‚ãƒªã‚«ãƒãƒªãƒ¼ã®å·¥æ•°ã¯å¤šã‹ã£ãŸã€‚
